
<% if user_signed_in? %>
  <h1>Classements Pilotes</h1>  <br/>

  <%= render "shared/choixevent" %>

  <% if (@eventId).present? %>

    <%# tempo test val max %>
    
  <% @numGp = Event.find(@eventId).numero   %>

    <%= render "shared/eventactif" %>

    <%# boutons crea classement %>
    <%= link_to "CrÃ©er classement", toggle_creerclassements_classement_path(@eventId), class:"btn btn-warning", style:"margin: 2px"  %>
    <%= link_to "Update classement", toggle_updateclassements_classement_path(@eventId), class:"btn btn-primary", style:"margin: 2px" %>
    <%= link_to "Supprimer classement", toggle_supprimerclassements_classement_path(@eventId), class:"btn btn-danger", style:"margin: 2px"%>
    <%= link_to "Trier classement", toggle_triclassements_classement_path(@eventId), class:"btn btn-secondary", style:"margin: 2px"%>
 
   <br><br>
    <%#= max points : <%= Classement.saison_courant(@saisonId).division_courant(@divisionId).numero_until_courant(@numGp).max_points.score.to_i %>
    
    <%#= tableau data classement %>

    <table class="table table-striped table-bordered table-hover">
      <thead class="table-dark">
        <tr>
          <th style="text-align: center;">#</th>
          <th>Pilote</th>
           <th>Ecurie</th>
          <th style="text-align: center;">total</th>

         <%# <th>rank n-1</th> %>
          <th style="text-align: center;">delta rank </th>

        <%#  <th>nb p1</th>
          <th>nb p2</th>
          <th>nb p3</th>
          <th>nb p4</th>
          <th>nb p5</th>
          <th>nb p6</th>
          <th>nb p7</th>
          <th>nb p8</th>
          <th>nb p9</th>
          <th>nb p10</th>
          <th>nb p11</th>
          <th>nb p12</th>
          <th>nb p13</th>
          <th>nb p14</th>
          <th>nb p15</th>
          <th>nb p16</th>
          <th>nb p17</th>
          <th>nb p18</th>
          <th>nb p19</th>
          <th>nb p20</th> %>

        </tr>
      </thead>

      <tbody>
        <tr>
        <% @classements.order(:position).each do | classement | %>
            <td class="col_centree">  <%= classement.position %></td>
            <td> <%= Pilote.find(classement.pilote_id).nom %>  </td>
             <td> 
                  <% idEcurie = Pilote.find(classement.pilote_id).ecurie %>  
                  <% nomEcurie = Equipe.find(idEcurie).nom %> 
                  <% nomEcurie %>
                  <% if Equipe.find(idEcurie).logo.present? %>
                      <%= image_tag Equipe.find(idEcurie).logo, style: "width: 300px; display: block", class: "img-fluid rounded" %>
                  <% end %>
              </td>

            <td class="col_centree">  <%= number_with_precision(classement.score, precision: 0) %>  </td>

            <% precedentGpNum = @numGp - 1 %>
            <% if precedentGpNum > 0 %>
              <% precedentGpId = Event.where(numero: precedentGpNum, saison_id: @saisonId, division_id: @divisionId).first.id %>

                <% if Classement.where(event_id: precedentGpId, pilote_id: classement.pilote_id).present? %>
                  <% rankN_1 = Classement.where(event_id: precedentGpId, pilote_id: classement.pilote_id).first.position %>
                <% else %>
                   <% rankN_1 = 20 %>
                <% end %>

               <% @valDeltaRank = classement.position.to_i - rankN_1.to_i %>
               
                <td class="col_centree">
                  <% if @valDeltaRank < 0 %>
                      <strong class="col_rank_gain">
                      <%= sprintf("%+d", @valDeltaRank) %>
                      </strong>
                    <% else %>
                      <strong class="col_rank_perte">
                        <%= sprintf("%+d", @valDeltaRank) %>
                      </strong>
                    <% end %>   
                 </td>
            <% end %>

        </tr>
        <% end %>
      </tbody>
    </table> <hr/>
        
    <%# PDF event actif %>
    <% numGp = Event.find(@eventId).numero %>
    <%= link_to "PDF",  classements_path(saisonId: @saisonId, divisionId: @divisionId, eventId: @eventId, numGp: numGp, format: :pdf), class:"btn btn-dark" %>

   <% end %>

<% else %>
  <br/>   <strong>Vous n'avez pas les droits...</strong>
<% end %>

<br>

